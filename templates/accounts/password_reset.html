{% extends "base.html" %}

{% block title %}Reset Password | {{ site_name }}{% endblock %}

{% block body %}
<main class="min-h-screen">
  {% include "includes/header.html" %}

  <section class="relative min-h-screen overflow-hidden pt-24">
    <div class="absolute inset-0" style="background: radial-gradient(ellipse at top, hsl(0 0% 12%), hsl(0 0% 4%), hsl(0 0% 4%))"></div>
    <div class="relative mx-auto max-w-7xl px-6 py-24 lg:px-8 lg:py-32">
      <div class="mx-auto max-w-md">
        <div class="rounded-2xl border border-border bg-card p-8">
          <div class="text-center mb-8">
            <h1 class="text-2xl font-semibold tracking-tight">Reset Password</h1>
            <p class="mt-2 text-sm text-muted-foreground">
              Enter your new password below
            </p>
          </div>

          {% if error %}
          <div class="rounded-lg border border-red-500/30 bg-red-500/10 p-4 mb-6" id="token-error">
            <p class="text-sm text-red-200">{{ error }}</p>
            <a href="/accounts/login/" class="text-sm text-accent hover:underline mt-2 inline-block">
              Back to Sign In
            </a>
          </div>
          {% elif token %}
          <form id="reset-form" class="space-y-4" onsubmit="return handleReset(event)">
            <input type="hidden" id="reset-token" value="{{ token }}">
            <div>
              <label for="new-password" class="block text-sm font-medium text-foreground mb-1">New Password</label>
              <input type="password" id="new-password" name="new_password" required minlength="8"
                     class="w-full rounded-md border border-border bg-background px-4 py-2.5 text-sm text-foreground placeholder-muted-foreground focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent"
                     placeholder="At least 8 characters">
            </div>
            <div>
              <label for="confirm-password" class="block text-sm font-medium text-foreground mb-1">Confirm Password</label>
              <input type="password" id="confirm-password" name="confirm_password" required minlength="8"
                     class="w-full rounded-md border border-border bg-background px-4 py-2.5 text-sm text-foreground placeholder-muted-foreground focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent"
                     placeholder="Confirm your new password">
            </div>
            <div id="reset-error" class="text-sm text-red-400 hidden"></div>
            <div id="reset-success" class="text-sm text-green-400 hidden"></div>
            <button type="submit" id="reset-submit"
                    class="w-full rounded-md bg-accent px-4 py-2.5 text-sm font-medium text-accent-foreground transition-colors hover:bg-accent/90">
              Reset Password
            </button>
          </form>
          {% endif %}

          <div class="mt-6 text-center">
            <a href="/accounts/login/" class="text-sm text-accent hover:underline">
              Back to Sign In
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  {% include "includes/footer.html" %}
</main>
{% endblock %}

{% block extra_scripts %}
<script>
function getCsrfToken() {
  var cookies = document.cookie.split(';');
  for (var i = 0; i < cookies.length; i++) {
    var cookie = cookies[i].trim();
    if (cookie.startsWith('csrftoken=')) {
      return cookie.substring('csrftoken='.length);
    }
  }
  return '';
}

function handleReset(event) {
  event.preventDefault();
  var token = document.getElementById('reset-token').value;
  var newPassword = document.getElementById('new-password').value;
  var confirmPassword = document.getElementById('confirm-password').value;
  var errorDiv = document.getElementById('reset-error');
  var successDiv = document.getElementById('reset-success');

  errorDiv.classList.add('hidden');
  successDiv.classList.add('hidden');

  if (newPassword !== confirmPassword) {
    errorDiv.textContent = 'Passwords do not match';
    errorDiv.classList.remove('hidden');
    return false;
  }

  fetch('/api/password-reset', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: JSON.stringify({ token: token, new_password: newPassword }),
  })
  .then(function(resp) { return resp.json().then(function(data) { return { status: resp.status, data: data }; }); })
  .then(function(result) {
    if (result.data.status === 'ok') {
      successDiv.textContent = result.data.message + ' Redirecting to sign in...';
      successDiv.classList.remove('hidden');
      document.getElementById('reset-form').reset();
      setTimeout(function() { window.location.href = '/accounts/login/'; }, 2000);
    } else {
      errorDiv.textContent = result.data.error || 'Password reset failed';
      errorDiv.classList.remove('hidden');
    }
  })
  .catch(function() {
    errorDiv.textContent = 'An error occurred. Please try again.';
    errorDiv.classList.remove('hidden');
  });

  return false;
}
</script>
{% endblock %}
