{% extends "base.html" %}
{% load access_tags %}

{% block title %}{{ event.title }} | AI Shipping Labs{% endblock %}
{% block meta_description %}{{ event.description|truncatewords:30 }}{% endblock %}

{% block body %}
{% include "includes/header.html" %}
<main class="min-h-screen pt-24">
  <article class="py-16 lg:py-24">
    <div class="mx-auto max-w-4xl px-6 lg:px-8">
      <a href="/events" class="mb-8 inline-flex items-center gap-2 text-sm text-muted-foreground transition-colors hover:text-foreground">
        <i data-lucide="arrow-left" class="h-4 w-4"></i>
        Back to Events
      </a>

      <header class="mb-12">
        <!-- Status & Type Badges -->
        <div class="mb-4 flex flex-wrap items-center gap-2">
          <span class="inline-flex items-center gap-1.5 rounded-full border border-accent/30 bg-accent/10 px-4 py-1.5 text-sm text-accent">
            {% if event.event_type == 'live' %}<i data-lucide="radio" class="h-4 w-4"></i>{% else %}<i data-lucide="clock" class="h-4 w-4"></i>{% endif %}
            {{ event.get_event_type_display }} Event
          </span>
          <span class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-xs font-medium
            {% if event.status == 'upcoming' %}bg-blue-500/20 text-blue-400
            {% elif event.status == 'live' %}bg-red-500/20 text-red-400
            {% elif event.status == 'completed' %}bg-green-500/20 text-green-400
            {% elif event.status == 'cancelled' %}bg-gray-500/20 text-gray-400
            {% else %}bg-secondary text-muted-foreground{% endif %}">
            {{ event.get_status_display }}
          </span>
          {% if event.required_level > 0 %}
          <span class="inline-flex items-center gap-1 rounded-full bg-accent/20 px-3 py-1 text-xs font-medium text-accent">
            <i data-lucide="lock" class="h-3 w-3"></i>
            {{ event.required_level|required_tier_name }}
          </span>
          {% endif %}
        </div>

        <h1 class="text-3xl font-semibold tracking-tight sm:text-4xl lg:text-5xl" style="text-wrap: balance;">
          {{ event.title }}
        </h1>

        <div class="mt-6 flex flex-wrap items-center gap-4 text-sm text-muted-foreground">
          <span class="flex items-center gap-1.5">
            <i data-lucide="calendar" class="h-4 w-4"></i>
            {{ event.formatted_start }}
          </span>
          {% if event.end_datetime %}
          <span class="flex items-center gap-1.5">
            <i data-lucide="clock" class="h-4 w-4"></i>
            Until {{ event.end_datetime|date:"H:i" }} UTC
          </span>
          {% endif %}
          {% if event.location %}
          <span class="flex items-center gap-1.5">
            <i data-lucide="map-pin" class="h-4 w-4"></i>
            {{ event.location }}
          </span>
          {% endif %}
          {% if event.timezone %}
          <span class="flex items-center gap-1.5">
            <i data-lucide="globe" class="h-4 w-4"></i>
            {{ event.timezone }}
          </span>
          {% endif %}
        </div>

        {% if event.tags %}
        <div class="mt-4 flex flex-wrap gap-2">
          {% for tag in event.tags %}
          <span class="rounded-full bg-secondary px-3 py-1 text-xs text-muted-foreground">{{ tag }}</span>
          {% endfor %}
        </div>
        {% endif %}
      </header>

      <!-- Registration / Action Section -->
      {% if event.status == 'upcoming' or event.status == 'live' %}
      <div class="mb-12 rounded-lg border border-border bg-card p-6">
        {% if not user.is_authenticated %}
          <!-- Anonymous user - show login CTA -->
          <div class="text-center">
            <p class="text-lg font-semibold text-foreground">Sign in to register for this event</p>
            <p class="mt-2 text-sm text-muted-foreground">Create an account or sign in to register.</p>
            <a href="/accounts/login/?next=/events/{{ event.slug }}"
               class="mt-4 inline-flex items-center gap-2 rounded-lg bg-accent px-6 py-3 text-sm font-medium text-accent-foreground transition-colors hover:bg-accent/90">
              Sign In
            </a>
          </div>
        {% elif not has_access %}
          <!-- User doesn't have access - show upgrade CTA -->
          <div class="text-center">
            <div class="mb-4">
              <i data-lucide="lock" class="mx-auto h-10 w-10 text-accent"></i>
            </div>
            <p class="text-lg font-semibold text-foreground">Upgrade to {{ required_tier_name }} to attend</p>
            <p class="mt-2 text-sm text-muted-foreground">This event requires a {{ required_tier_name }} membership or above.</p>
            <a href="/pricing"
               class="mt-4 inline-flex items-center gap-2 rounded-lg bg-accent px-6 py-3 text-sm font-medium text-accent-foreground transition-colors hover:bg-accent/90">
              <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
              View Pricing
            </a>
          </div>
        {% elif event.is_full and not is_registered %}
          <!-- Event is full -->
          <div class="text-center">
            <i data-lucide="users" class="mx-auto h-10 w-10 text-muted-foreground"></i>
            <p class="mt-4 text-lg font-semibold text-foreground">Event is full</p>
            <p class="mt-2 text-sm text-muted-foreground">This event has reached its maximum capacity.</p>
          </div>
        {% elif is_registered %}
          <!-- Already registered -->
          <div class="flex flex-col items-center gap-4 sm:flex-row sm:justify-between">
            <div class="flex items-center gap-3">
              <div class="rounded-full bg-green-500/20 p-2">
                <i data-lucide="check" class="h-5 w-5 text-green-400"></i>
              </div>
              <div>
                <p class="font-semibold text-foreground">You're registered!</p>
                {% if event.spots_remaining is not None %}
                <p class="text-sm text-muted-foreground">{{ event.registration_count }}/{{ event.max_participants }} spots taken</p>
                {% endif %}
              </div>
            </div>
            <button onclick="unregisterFromEvent('{{ event.slug }}')"
                    class="rounded-lg border border-border px-4 py-2 text-sm text-muted-foreground transition-colors hover:border-red-500/50 hover:text-red-400"
                    id="unregister-btn">
              Cancel Registration
            </button>
          </div>

          {% if show_zoom_link %}
          <!-- Zoom join link (shown 15 min before start) -->
          <div class="mt-4 rounded-lg border border-accent/30 bg-accent/5 p-4">
            <div class="flex items-center gap-3">
              <i data-lucide="video" class="h-5 w-5 text-accent"></i>
              <div>
                <p class="font-semibold text-foreground">Join the event</p>
                <a href="{{ event.zoom_join_url }}" target="_blank" rel="noopener noreferrer"
                   class="text-accent hover:underline">
                  {{ event.zoom_join_url }}
                </a>
              </div>
            </div>
          </div>
          {% endif %}
        {% else %}
          <!-- Can register -->
          <div class="flex flex-col items-center gap-4 sm:flex-row sm:justify-between">
            <div>
              <p class="font-semibold text-foreground">Register for this event</p>
              {% if event.spots_remaining is not None %}
              <p class="text-sm text-muted-foreground">{{ event.spots_remaining }} spot{{ event.spots_remaining|pluralize }} remaining</p>
              {% endif %}
            </div>
            <button onclick="registerForEvent('{{ event.slug }}')"
                    class="rounded-lg bg-accent px-6 py-3 text-sm font-medium text-accent-foreground transition-colors hover:bg-accent/90"
                    id="register-btn">
              Register
            </button>
          </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Completed event with recording -->
      {% if event.status == 'completed' and event.recording %}
      <div class="mb-12 rounded-lg border border-accent/30 bg-accent/5 p-6">
        <div class="flex items-center gap-3">
          <i data-lucide="play-circle" class="h-6 w-6 text-accent"></i>
          <div>
            <p class="font-semibold text-foreground">This event has been recorded</p>
            <a href="/event-recordings/{{ event.recording.slug }}" class="text-accent hover:underline">
              Watch the recording
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Description -->
      {% if event.description_html %}
      <div class="prose">
        {{ event.description_html|safe }}
      </div>
      {% elif event.description %}
      <div class="prose">
        <p class="text-muted-foreground">{{ event.description }}</p>
      </div>
      {% endif %}
    </div>
  </article>
</main>
{% include "includes/footer.html" %}
{% endblock %}

{% block extra_scripts %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function registerForEvent(slug) {
  const btn = document.getElementById('register-btn');
  btn.disabled = true;
  btn.textContent = 'Registering...';

  fetch('/api/events/' + slug + '/register', {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json',
    },
  })
  .then(response => {
    if (response.ok) {
      window.location.reload();
    } else {
      return response.json().then(data => {
        alert(data.error || 'Registration failed');
        btn.disabled = false;
        btn.textContent = 'Register';
      });
    }
  })
  .catch(() => {
    alert('Network error. Please try again.');
    btn.disabled = false;
    btn.textContent = 'Register';
  });
}

function unregisterFromEvent(slug) {
  if (!confirm('Are you sure you want to cancel your registration?')) return;

  const btn = document.getElementById('unregister-btn');
  btn.disabled = true;
  btn.textContent = 'Cancelling...';

  fetch('/api/events/' + slug + '/unregister', {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
    },
  })
  .then(response => {
    if (response.ok) {
      window.location.reload();
    } else {
      return response.json().then(data => {
        alert(data.error || 'Unregistration failed');
        btn.disabled = false;
        btn.textContent = 'Cancel Registration';
      });
    }
  })
  .catch(() => {
    alert('Network error. Please try again.');
    btn.disabled = false;
    btn.textContent = 'Cancel Registration';
  });
}
</script>
{% endblock %}
